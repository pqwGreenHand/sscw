<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 <mapper namespace="com.zhixin.zhfz.common.dao.notice.IInformMapper" >
  <resultMap id="informResultMap" type="com.zhixin.zhfz.common.entity.InformEntity" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="sender_id" property="senderId" jdbcType="INTEGER" />
    <result column="receiver_id" property="receiverId" jdbcType="INTEGER" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="INTEGER" />
    <result column="send_time" property="sendTime" jdbcType="TIMESTAMP" />
    <result column="is_read" property="isRead" jdbcType="INTEGER" />
    <result column="read_time" property="readTime" jdbcType="TIMESTAMP" />
    <result column="sender_name" property="senderName" jdbcType="VARCHAR" />
    <result column="receiverName" property="receiverName" jdbcType="VARCHAR" />
  </resultMap>

  <select id="list" resultMap="informResultMap" parameterType="java.util.Map">
     select a.*,IFNULL(b.real_name,a.sender_id) sender_name,c.real_name as receiverName
     from xt_inform a left join xt_user b on a.sender_id=b.id
      left join xt_user c
      on a.receiver_id = c.id
     where is_read=0
     <if test="receiverId!=null and receiverId!=''">
       and a.receiver_id =#{receiverId}
     </if>
     <if test="id!=null and id!=''">
       and a.id =#{id}
     </if>

      <if test="title!=null and title!=''">
          and a.title like '%${title}%'
      </if>

      <if test="content!=null and content!=''">
          and a.content like '%${content}%'
      </if>

      <if test="systemName!=null and systemName!=''">
          and a.system_name =#{systemName}
      </if>
      order by id desc
      limit ${pageStart},${rows}
  </select>

    <select id="count" resultType="java.lang.Integer" parameterType="java.util.Map">
        select count(1)
        from xt_inform a left join xt_user b on a.sender_id=b.id
        where is_read=0
        <if test="receiverId!=null and receiverId!=''">
            and a.receiver_id =#{receiverId}
        </if>
        <if test="id!=null and id!=''">
            and a.id =#{id}
        </if>

        <if test="title!=null and title!=''">
            and a.title like '%${title}%'
        </if>

        <if test="content!=null and content!=''">
            and a.content like '%${content}%'
        </if>

        <if test="systemName!=null and systemName!=''">
            and a.system_name =#{systemName}
        </if>
    </select>
  
  <insert id="insert" parameterType="com.zhixin.zhfz.common.entity.InformEntity" useGeneratedKeys="true" keyProperty="id">
       insert into ba_inform
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <!--<if test="id != null" >-->
        <!--id,-->
      <!--</if>-->
      <if test="senderId != null" >
        sender_id,
      </if>
      <if test="receiverId != null" >
        receiver_id,
      </if>
      <if test="title != null" >
        title,
      </if>
      <if test="content != null" >
        content,
      </if>
       <if test="type != null" >
        type,
       </if>
        send_time,
		<if test="isRead != null" >
        is_read,
        </if>
        <if test="opPid != null" >
            op_pid
        </if>

    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <!--<if test="id != null" >-->
        <!--#{id,jdbcType=BIGINT},-->
      <!--</if>-->
      <if test="senderId != null" >
        #{senderId,jdbcType=INTEGER},
      </if>
      <if test="receiverId != null" >
        #{receiverId,jdbcType=INTEGER},
      </if>
      <if test="title != null" >
         #{title,jdbcType=VARCHAR},
      </if>
      <if test="content != null" >
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=INTEGER},
      </if>
      now(),
      <if test="isRead != null" >
       #{isRead,jdbcType=INTEGER},
        </if>
        <if test="opPid != null" >
            #{opPid,jdbcType=VARCHAR},
        </if>

    </trim>
    </insert>
    
    <select id="listhistory" resultMap="informResultMap" parameterType="java.util.Map">
        select a.*,b.real_name sender_name
		from ba_inform a left join xt_user b on a.sender_id=b.id
        where a.is_read = 1
           <if test="receiverId!=null and receiverId!=''">
                 and a.receiver_id = #{receiverId}
           </if>
           <if test="senderName!=null and senderName!=''">
                 and b.real_name like '%${senderName}%'
           </if>
           <if test="title!=null and title!=''">
                 and a.title like '%${title}%'
           </if>
           <if test="isRead!=null and isRead!=''">
                and a.is_read = #{isRead}
           </if>
           <if test="beginTime!=null and beginTime!=''">
                 and a.send_time &gt; #{beginTime}
           </if>
           <if test="endTime!=null and endTime!=''">
                 and a.send_time &lt; #{endTime}
           </if>
           order by a.id desc 
           limit ${pageStart},${rows}
    </select>
    <select id="listhistoryCount" resultType="java.lang.Integer" parameterType="java.util.Map">
        select count(1)
		from ba_inform a left join xt_user b on a.sender_id=b.id
        where a.is_read = 1
           <if test="receiverId!=null and receiverId!=''">
                 and a.receiver_id = #{receiverId}
           </if>
           <if test="senderName!=null and senderName!=''">
                 and b.real_name like '%${senderName}%'
           </if>
           <if test="title!=null and title!=''">
                 and a.title like '%${title}%'
           </if>
           <if test="isRead!=null and isRead!=''">
                and a.is_read = #{isRead}
           </if>
           <if test="beginTime!=null and beginTime!=''">
                 and a.send_time &gt; #{beginTime}
           </if>
           <if test="endTime!=null and endTime!=''">
                 and a.send_time &lt; #{endTime}
           </if>
    </select>
    <update id="updatInformById" parameterType="java.lang.Long" >
    	update xt_inform set is_read =1,read_time=now() where  id=#{id}
    </update>
    
    <update id="changeInformOvertime">
    	update inform set is_read =1,read_time=now() where TIMEDIFF(now(),send_time) &gt;=240000
    </update>

    <select id="isInform" parameterType="com.zhixin.zhfz.common.entity.InformEntity" resultType="java.lang.Integer">
      select count(1) from ba_inform
      where sender_id = #{senderId} and receiver_id = #{receiverId} and title = #{title}
      and content = #{content} and type = #{type} and is_read = 0
    </select>
    
    <delete id="cleanInform">  
            delete from ba_inform where TIMEDIFF(now(),send_time) &gt;=2400000
    </delete>
    
</mapper>