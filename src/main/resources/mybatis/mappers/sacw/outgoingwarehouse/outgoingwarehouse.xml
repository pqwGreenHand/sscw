<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhixin.zhfz.sacw.dao.outgoingwarehouse.OutgoingWarehouseMapper">

    <resultMap id="typeInvolvedResultMap" type="com.zhixin.zhfz.sacw.entity.OutgoingEntity">
        <id property="id" column="id"/>
        <result property="typeName" column="code_value"/>
        <result property="counts" column="counts"/>
        <result property="count" column="count"/>
        <result property="name" column="name"/>
        <result property="wareHouseId" column="warehouse_id"/>

    </resultMap>
    <resultMap id="inputMap" type="com.zhixin.zhfz.sacw.entity.InputEntity">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="lawCaseId" column="case_id" jdbcType="INTEGER"/>
        <result property="caseNo" column="caseNo" jdbcType="VARCHAR"/>
        <result property="caseName" column="caseName" jdbcType="VARCHAR"/>
        <result property="woodsName" column="woodsName" jdbcType="VARCHAR"/>
        <result property="woodsType" column="woodsType" jdbcType="VARCHAR"/>
        <result property="involvedId" column="involved_id" jdbcType="INTEGER"/>
        <result property="locationId" column="location_id" jdbcType="INTEGER"/>
        <result property="involvedTypeId" column="involved_type_id" jdbcType="INTEGER"/>
        <result property="inputTypeId" column="input_type_id" jdbcType="INTEGER"/>
        <result property="barcode" column="barcode" jdbcType="VARCHAR"/>

        <result property="policeId1" column="police_id1" jdbcType="INTEGER"/>
        <result property="shelfId" column="shelf_id" jdbcType="INTEGER"/>
        <result property="warehouseId" column="warehouse_id" jdbcType="INTEGER"/>
        <result property="count" column="count" jdbcType="INTEGER"/>
        <result property="inputTime" column="inputTime" jdbcType="TIMESTAMP"/>
        <result property="registerUserId" column="registerUserId" jdbcType="INTEGER"/>
        <result property="registerUserName" column="registerUserName" jdbcType="VARCHAR"/>
        <result property="location" column="location" jdbcType="VARCHAR"/>
        <result property="createdTime" column="createdTime" jdbcType="TIMESTAMP"/>
        <result property="updatedTime" column="updatedTime" jdbcType="TIMESTAMP"/>
        <result property="labelId" column="label_id" jdbcType="INTEGER"/>
        <result property="labelNo" column="label_no" jdbcType="VARCHAR"/>
    </resultMap>


    <select id="listInvolved" resultMap="typeInvolvedResultMap" parameterType="java.util.Map">
        SELECT
        a.id,
        COUNT(a.id) as counts,
        b.code_value
        FROM
        sa_location a,xt_code b,xt_organization t,sa_warehouse w WHERE a.location_type_id = b.code_key AND w.org_id=
        t.id AND a.warehouse_id = w.id
        AND b.type = 'INVOLVED_TYPE' AND b.code_key=#{type}
        <if test="wareHouseId!=null and wareHouseId !=''">
            AND a.warehouse_id = #{wareHouseId}
        </if>
        <if test="dataAuth!=null and dataAuth!=''">
            and ${dataAuth}
        </if>
    </select>

    <select id="listInvolvedDetailed" resultMap="typeInvolvedResultMap" parameterType="java.util.Map">
        SELECT
        a.id,
        a.`name`,
        SUM(bb.detail_count) AS count
        FROM
        sa_location a
        LEFT JOIN (
        SELECT
        i.id,
        i.`name`,
        b.location_id,
        i.detail_count
        FROM
        sa_involved i,
        sa_input_record b
        WHERE
        i.id = b.involved_id
        AND i.`status` = 2
        ) bb ON a.id = bb.location_id
        LEFT JOIN xt_code c ON a.location_type_id = c.code_key
        LEFT JOIN sa_warehouse w ON a.warehouse_id = w.id
        LEFT JOIN xt_organization t ON w.org_id = t.id
        WHERE
        c.type = 'INVOLVED_TYPE'
        AND c.code_key = #{type}
        <if test="wareHouseId!=null and wareHouseId !=''">
            AND a.warehouse_id = #{wareHouseId}
        </if>
        <if test="dataAuth!=null and dataAuth!=''">
            and ${dataAuth}
        </if>
        GROUP BY a.name
    </select>

    <select id="inputList" resultMap="inputMap" parameterType="java.util.Map">
        select l.id,l.involved_id,ilc.ajbh caseNo,ilc.ajmc caseName,ii.name woodsName,ii.barcode,
        ii.detail_count count,cd.code_value woodsType,l.input_time inputTime,u.real_name registerUserName,
        CONCAT(iw.name,lo.name ,IFNULL(ise.no,''))location,lb.label_no
        from sa_input_record l
        left join ba_case ilc on l.case_id=ilc.id
        left join sa_involved ii on l.involved_id=ii.id
        left join xt_code cd on l.involved_type_id=cd.code_key and cd.type='INVOLVED_TYPE'
        left join xt_user u on l.register_user_id=u.id
        left join sa_location lo on l.location_id=lo.id
        left join sa_warehouse iw on l.warehouse_id=iw.id
        left join sa_shelf ise on l.shelf_id=ise.id
        left join sa_label lb on ii.label_id=lb.id
        LEFT JOIN xt_organization t ON iw.org_id = t.id
        <where>
            ii.`status` = 2
            <if test="involvedTypeId!=null and involvedTypeId!=''">
                and l.involved_type_id = #{involvedTypeId}
            </if>
            <if test="dataAuth!=null and dataAuth!=''">
                and ${dataAuth}
            </if>
            <if test="locationId!=null and locationId!=''">
                and lo.id =#{locationId}
            </if>
            <if test="woodsName!=null and woodsName!=''">
                and ii.name like '%${woodsName}%'
            </if>
        </where>
        order by l.input_time desc limit ${pageStart},${rows}

    </select>

    <select id="count" resultType="java.lang.Integer" parameterType="java.util.Map">
        select count(1)
        from sa_input_record l
        left join ba_case ilc on l.case_id=ilc.id
        left join sa_involved ii on l.involved_id=ii.id
        left join xt_code cd on l.involved_type_id=cd.code_key and cd.type='INVOLVED_TYPE'
        left join xt_user u on l.register_user_id=u.id
        left join sa_location lo on l.location_id=lo.id
        left join sa_warehouse iw on l.warehouse_id=iw.id
        left join sa_shelf ise on l.shelf_id=ise.id
        left join sa_label lb on ii.label_id=lb.id
        LEFT JOIN xt_organization t ON iw.org_id = t.id
        <where>
            ii.`status` = 2
            <if test="involvedTypeId!=null and involvedTypeId!=''">
                and l.involved_type_id = #{involvedTypeId}
            </if>
            <if test="dataAuth!=null and dataAuth!=''">
                and ${dataAuth}
            </if>
            <if test="locationId!=null and locationId!=''">
                and lo.id =#{locationId}
            </if>
            <if test="woodsName!=null and woodsName!=''">
                and ii.name like '%${woodsName}%'
            </if>
        </where>
    </select>


</mapper>